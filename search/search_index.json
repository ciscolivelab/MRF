{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Home","text":""},{"location":"#ltrxar-2003","title":"LTRXAR - 2003","text":"<p>Welcome to Cisco Live LTRXAR-2003 - SD-WAN Multi-Region Fabric(MRF) Migration Lab</p> <p>For full documentation visit Cisco Live.</p>"},{"location":"#speakers","title":"Speakers","text":"<ul> <li>Lei Tian <code>Customer Delivery Architect, Cisco CX</code></li> <li>Oscar Eduardo Desentis Clemente <code>Customer Delivery Architect, Cisco CX</code></li> </ul>"},{"location":"about/","title":"About The Lab","text":""},{"location":"about/#multi-region-fabric-mrf-overview","title":"Multi-Region Fabric (MRF) Overview","text":"<p>The current Catalyst SDWAN architecture follows a flat overlay model, establishing site-to-site tunnels directly between sites. While this flat overlay model functions adequately in many scenarios, it does have its limitations:  </p> <ul> <li>Centralized control policy is necessary for Hub and Spoke topology or setting route preferences. Depending on the specific requirements of the topology, this policy can become quite complex.  </li> <li>Integrating transports from disparate providers for the underlay can be challenging. This is particularly relevant when attempting to leverage middle mile providers or cloud backbone providers' networks for inter-region traffic.  </li> <li>Large enterprises and managed service providers (MSPs) often require SDWAN to extend across multiple regions.  </li> </ul> <p>Now, with Multi-Region Fabric (MRF), it offers following enhancements  </p> <ul> <li>Foundational capability that underpins our journey to multi-cloud and SDCI  <ul> <li>Ensure market-leading scalability  </li> <li>Service enablement at gateway points</li> <li>Increase network resiliency  </li> </ul> </li> <li>Improve OMP to support a true scalable Multi-Region Fabric SD-WAN  </li> <li>3-level customer overlay  <ul> <li>Introduces Regions  </li> <li>Primary Access Region  </li> <li>Secondary Region  </li> <li>Subregion  </li> <li>Border routers provide tunnel stitching  </li> <li>Inter Regions always goes via border routers  </li> </ul> </li> <li>End to end SLA aware path computation  </li> <li>Simplifies user-visible configuration  </li> </ul>"},{"location":"about/#about-this-lab","title":"About This Lab","text":"<p>This lab has been designed to showcase a comprehensive array of MRF features provided by the Cisco SD-WAN solution in a systematic manner. While a predefined topology is outlined and associated with each scenario, the lab instructions can also be tailored to the specific requirements of attendees. Participants can utilize the steps outlined in this lab to transition their flat fabric into an MRF.  </p> <p>Upon completing this lab, you will:  </p> <ul> <li>Gain insight into the intricacies of using the legacy approach to create and deploy hierarchical topologies within a flat Catalyst SD-WAN Fabric.  </li> <li>Successfully migrate from a flat Catalyst SD-WAN fabric to an MRF fabric with minimal disruption.  </li> <li>Understand the streamlined process for deploying a hierarchical topology using MRF fabric.  </li> <li>Understand and deploy MRF features such as 2nd region, transit gateway and MRF policy.  </li> </ul>"},{"location":"access/","title":"Lab Crendential","text":"<p>Below table provides the IP addresses and credentials for the devices used in this lab:  </p> <ul> <li>UI Connection Details</li> </ul> Node IP:Port Username Password Manager https://vmanage.dcloud.cisco.com:8443 admin C1sco12345 <ul> <li>SD-WAN Controllers</li> </ul> Hostname System IP Site ID Username Password Manager-1 1.1.1.1 1 admin C1sco12345 Validator-1 1.1.1.2 1 admin C1sco12345 Controller-1 1.1.1.3 1 admin C1sco12345 Controller-2 1.1.1.4 1 admin C1sco12345 Controller-3 1.1.1.5 1 admin C1sco12345 Controller-4 1.1.1.6 1 admin C1sco12345 <ul> <li>SD-WAN Edges</li> </ul> Hostname System IP Site ID Username Password BR-WEST-1 1.1.201.1 201 admin C1sco12345 BR-WEST-2 1.1.201.2 201 admin C1sco12345 BR-EAST-1 1.1.202.1 202 admin C1sco12345 BR-EAST-2 1.1.202.2 202 admin C1sco12345 EDGE-HUB-1-01 1.1.10.1 1010 admin C1sco12345 EDGE-HUB-1-02 1.1.10.2 1010 admin C1sco12345 EDGE-HUB-2-01 1.1.20.1 1020 admin C1sco12345 EDGE-HUB-2-02 1.1.20.2 1020 admin C1sco12345 EDGE-BRANCH-3-01 1.1.30.1 3000 admin C1sco12345 EDGE-BRANCH-4-01 1.1.40.1 4000 admin C1sco12345 EDGE-BRANCH-4-02 1.1.40.2 4000 admin C1sco12345 EDGE-BRANCH-5-01 1.1.50.1 5000 admin C1sco12345 EDGE-BRANCH-6-01 1.1.60.1 6000 admin C1sco12345 EDGE-BRANCH-7-01 1.1.70.1 7000 admin admin <ul> <li>SD-WAN Edges - Interfaces  </li> </ul> Hostname Pub-Inet TLOC If Pub-Inet IP Address MPLS TLOC If MPLS IP Address Private1 TLOC If Private1 IP Address Private2 TLOC If Private2 IP Address BR-WEST-1 Gi2 124.124.124.2/24 Gi1 10.2.1.2/24 Gi3 172.16.1.1/24 Gi4 172.16.2.1/24 BR-WEST-2 Gi2 125.125.125.2/24 Gi1 10.2.2.2/24 Gi3 172.16.1.2/24 Gi4 172.16.2.2/24 BR-EAST-1 Gi2 131.131.131/2/24 Gi1 10.2.3.1/24 Gi3 172.16.1.3/24 Gi4 172.16.2.3/24 BR-EAST-2 Gi2 132.132.132.2/24 Gi1 10.2.4.1/24 Gi3 172.16.1.4/24 Gi4 172.16.2.4/24 Hostname Pub-Inet TLOC If Pub-Inet IP Address MPLS TLOC If MPLS IP Address SVPN 10 If SVPN 10 IP Address SVPN 11 If SVPN 11 IP Address EDGE-DC-1-01 Gi1 126.126.126.2/24 Gi2 10.2.5.1/24 Gi3 10.10.1.1/24 Gi4 10.11.1.1/24 EDGE-DC-1-02 Gi1 128.128.128.2/24 Gi2 10.2.6.2/24 Gi3 10.10.1.2/24 Gi4 10.11.1.2/24 EDGE-DC-2-01 Gi1 129.129.129.2/24 Gi2 10.2.7.2/24 Gi3 10.20.1.1/24 Gi4 10.21.1.1/24 EDGE-DC-2-02 Gi1 130.130.130.2/24 Gi2 10.2.8.2/24 Gi3 10.20.1.2/24 Gi4 10.21.1.2/24 EDGE-BRANCH-3-01 Gi1 133.133.133.2/24 Gi2 10.2.9.2/24 Gi3 10.30.1.1/24 Gi4 10.31.1.1/24 EDGE-BRANCH-4-01 Gi1 144.144.144.2/24 Gi2 10.2.10.130/25 Gi3 10.40.1.1/24 Gi4 10.41.1.1/24 EDGE-BRANCH-4-02 Gi1 192.168.0.2/24 Gi2 10.2.10.2/25 Gi3 10.40.1.2/24 Gi4 10.41.1.2/24 EDGE-BRANCH-5-01 Gi1 145.145.145.2/24 Gi2 10.2.11.2/24 Gi3 10.50.1.129/25 Gi4 10.51.1.129/25 EDGE-BRANCH-6-01 Gi1 146.146.146.2/24 N/A N/A Gi2 10.60.1.1/24 Gi3 10.61.1.1/24 EDGE-BRANCH-7-01 N/A N/A Gi1 10.2.12.2/24 Gi2 10.70.1.129/25 Gi3 10.71.1.129/25"},{"location":"login/","title":"Login","text":"<p>You will initiate VPN connection to the network setup used in this lab.  All the devices in this lab are running as Virtual Instances.  At the end of this task, you will have VPN connection to this remote setup</p>"},{"location":"login/#step-1-connect-to-lab-using-anyconnect-vpn","title":"Step 1: Connect to lab using anyconnect VPN","text":"<p>You will connect to Anyconnect url using Cisco Secure client and with the username &amp; password as documented in below table.  Below screenshot shows an example of that VPN connection.</p> Pod ID Attendee Name Anyconnect url Anyconnect Username Anyconnect Password POD 1 Srinivasa Rao Burla dcloud-sjc-anyconnect.cisco.com v1448user1 3a4e36 POD 2 Dave Chard dcloud-sjc-anyconnect.cisco.com v566user1 7f0daa POD 3 Hyon Chu dcloud-sjc-anyconnect.cisco.com v1298user1 79989b POD 4 Derek Cox dcloud-sjc-anyconnect.cisco.com v1470user1 e61107 POD 5 DAVID HIERS dcloud-sjc-anyconnect.cisco.com v749user1 33eade POD 6 Gordy Hum dcloud-sjc-anyconnect.cisco.com v1225user1 12a819 POD 7 Tim Moorhead dcloud-sjc-anyconnect.cisco.com v211user1 62a91f POD 8 Benjamin Olson dcloud-sjc-anyconnect.cisco.com v1070user1 a0c265 <p>Note</p> <p>Please use the dcloud login associated with your name.  If you can't find your name in the table please ask the lab speakers.</p> <p></p>"},{"location":"login/#step-2-enter-vpn-credentials","title":"Step 2: Enter VPN credentials","text":"<p>After prompted for credentials, use the credentials documented in above table or provided by the lab admin.</p> <ul> <li>Below is an example of user logging into a reference POD:</li> </ul> <p></p> <ul> <li>Hit accept when the prompt appears to accept the VPN connection login</li> </ul> <p></p>"},{"location":"login/#step-3-rdp-to-workstation","title":"Step 3: RDP to workstation","text":"<p>In this step, you will connect to the workstation with Remote Desktop (RDP) client on your machines.  Use below details for this RDP session:</p> <ul> <li>Workstation: 198.18.133.36</li> <li>Username: admin</li> <li>Password: C1sco12345</li> </ul> <p>Below screenshot is only an example for this RDP connection:</p> <p></p>"},{"location":"login0/","title":"Login0","text":"<p>You will initiate VPN connection to the network setup used in this lab.  All the devices in this lab are running as Virtual Instances.  At the end of this task, you will have VPN connection to this remote setup</p>"},{"location":"login0/#step-1-connect-to-lab-using-anyconnect-vpn","title":"Step 1: Connect to lab using anyconnect VPN","text":"<p>You will connect to Anyconnect url using Cisco Secure client and with the username &amp; password as documented in below table.  Below screenshot shows an example of that VPN connection.</p> Pod ID Attendee Name Anyconnect url Anyconnect Username Anyconnect Password POD  1 dcloud-sjc-anyconnect.cisco.com POD  2 dcloud-sjc-anyconnect.cisco.com POD  3 dcloud-sjc-anyconnect.cisco.com POD  4 dcloud-sjc-anyconnect.cisco.com POD  5 dcloud-sjc-anyconnect.cisco.com POD  6 dcloud-sjc-anyconnect.cisco.com POD  7 dcloud-sjc-anyconnect.cisco.com POD  8 dcloud-sjc-anyconnect.cisco.com POD  9 dcloud-sjc-anyconnect.cisco.com POD  10 dcloud-sjc-anyconnect.cisco.com POD  11 dcloud-sjc-anyconnect.cisco.com POD  12 dcloud-sjc-anyconnect.cisco.com POD  13 dcloud-sjc-anyconnect.cisco.com POD  14 dcloud-sjc-anyconnect.cisco.com POD  15 dcloud-sjc-anyconnect.cisco.com POD  16 dcloud-sjc-anyconnect.cisco.com POD  17 dcloud-sjc-anyconnect.cisco.com POD  18 dcloud-sjc-anyconnect.cisco.com <p>Note</p> <p>Please use the dcloud login associated with your name.  If you can't find your name in the table please ask the lab speakers.</p> <p></p>"},{"location":"login0/#step-2-enter-vpn-credentials","title":"Step 2: Enter VPN credentials","text":"<p>After prompted for credentials, use the credentials documented in above table or provided by the lab admin.</p> <ul> <li>Below is an example of user logging into a reference POD:</li> </ul> <p></p> <ul> <li>Hit accept when the prompt appears to accept the VPN connection login</li> </ul> <p></p>"},{"location":"login0/#step-3-rdp-to-workstation","title":"Step 3: RDP to workstation","text":"<p>In this step, you will connect to the workstation with Remote Desktop (RDP) client on your machines.  Use below details for this RDP session:</p> <ul> <li>Workstation: 198.18.133.36</li> <li>Username: admin</li> <li>Password: C1sco12345</li> </ul> <p>Below screenshot is only an example for this RDP connection:</p> <p></p>"},{"location":"task1/","title":"Task 1 - Explore Flat Fabric Policy","text":""},{"location":"task1/#tips-for-the-lab","title":"Tips For The Lab","text":"<p>Use your browser Zoom In option to visualize better all images.  </p> <p></p> <p>Rediscovery Fabric Network to ensure all virtual nodes are reachable. Please inform the speaker if any virtual device appear as un-reachable.  </p> <p>Go to Tools &gt; Rediscovery Network, mark all the device checkboxes and click 'Rediscover'.  </p> <p> </p> <p>In this task you will review and understand the current active centralized policy that creates a Regional Hub &amp; Spoke topology. By default, SD-WAN solution builds a full mesh topology, any site will build tunnel with any other site. To build hub and spoke topology, or build regional hierarchy like we have in the lab, a centralized control policy is required.    </p>"},{"location":"task1/#step-1-review-existing-policy","title":"Step 1: Review existing policy","text":"<p>Once you have the RDP session to the remote workstation, open Chrome browser icon on the desktop.  </p> <ul> <li> <p>Enter https://vmanage.dcloud.cisco.com:8443 in browser address bar; login with username admin, password C1sco12345.  </p> </li> <li> <p>Click SD-WAN Manager navagination bar, go to Configuration &gt; Policies. Locate pre-configured policy REGIONAL_HUB_AND_SPOKE_BGP_CORE_POLICY, click the ... on the right and select Preview.  </p> </li> </ul> <p></p> <ul> <li>This REGIONAL_HUB_AND_SPOKE_BGP_CORE_POLICY adjusts the control plane to allow full-mesh intercommunication among all sites within the West region (Site ID 201,1010,1020,3000,4000,5000) while preventing direct connectivity to the East region. This is achieved by denying TLOCs and utilizing TLOC re-writes. The West Hub (Site 201) connects to the East Hub (Site 202) through the BGP core network using the service-side VPN.   </li> </ul> <p>Note</p> <p>Refer to the Regional Hub &amp; Spoke with BGP Core topology diagram for further analysis.</p> <ul> <li>As you can see it is a complex policy even for a very small environment with same two transports used everywhere.  </li> </ul> <pre><code>viptela-policy:policy\n control-policy EAST-BRANCHES-SITES-CP\n    sequence 1\n     match tloc\n      site-list EAST-ALL-SITES\n     !\n     action accept\n     !\n    !\n    sequence 11\n     match route\n      site-list EAST-ALL-SITES\n      prefix-list _AnyIpv4PrefixList\n     !\n     action accept\n     !\n    !\n    sequence 21\n     match route\n      site-list WEST-ALL-SITES\n      prefix-list _AnyIpv4PrefixList\n     !\n     action accept\n      set\n       tloc-list EAST-HUB-TLOCS\n      !\n     !\n    !\n  default-action reject\n !\n control-policy BGP-CORE-EAST-HUB-CP\n    sequence 1\n     match tloc\n      site-list EAST-ALL-SITES\n     !\n     action accept\n     !\n    !\n    sequence 11\n     match route\n      site-list EAST-ALL-SITES\n      prefix-list _AnyIpv4PrefixList\n     !\n     action accept\n     !\n    !\n  default-action reject\n !\n control-policy BGP-CORE-WEST-HUB-CP\n    sequence 1\n     match tloc\n      site-list WEST-ALL-SITES\n     !\n     action accept\n     !\n    !\n    sequence 11\n     match route\n      site-list WEST-ALL-SITES\n      prefix-list _AnyIpv4PrefixList\n     !\n     action accept\n     !\n    !\n  default-action reject\n !\n control-policy WEST-BRANCHES-SITES-CP\n    sequence 1\n     match tloc\n      site-list WEST-ALL-SITES\n     !\n     action accept\n     !\n    !\n    sequence 11\n     match route\n      site-list WEST-ALL-SITES\n      prefix-list _AnyIpv4PrefixList\n     !\n     action accept\n     !\n    !\n    sequence 21\n     match route\n      site-list EAST-ALL-SITES\n      prefix-list _AnyIpv4PrefixList\n     !\n     action accept\n      set\n       tloc-list WEST-HUB-TLOCS\n      !\n     !\n    !\n  default-action reject\n !\n lists\n  site-list EAST-ALL-SITES\n   site-id 202 \n   site-id 6000-7000 \n  !\n  site-list EAST-BRANCHES\n   site-id 6000 \n   site-id 7000 \n  !\n  site-list EAST-HUB\n   site-id 202 \n  !\n  site-list WEST-ALL-SITES\n   site-id 201 \n   site-id 1010-1020 \n   site-id 3000-5000 \n  !\n  site-list WEST-BRANCHES\n   site-id 1010-1020 \n   site-id 3000 \n   site-id 4000 \n   site-id 5000 \n  !\n  site-list WEST-HUB\n   site-id 201 \n  !\n  tloc-list EAST-HUB-TLOCS\n   tloc 1.1.202.1 color public-internet encap ipsec \n   tloc 1.1.202.1 color mpls encap ipsec \n   tloc 1.1.202.2 color public-internet encap ipsec \n   tloc 1.1.202.2 color mpls encap ipsec \n  !\n  tloc-list WEST-HUB-TLOCS\n   tloc 1.1.201.1 color public-internet encap ipsec \n   tloc 1.1.201.1 color mpls encap ipsec \n   tloc 1.1.201.2 color public-internet encap ipsec \n   tloc 1.1.201.2 color mpls encap ipsec \n  !\n  prefix-list _AnyIpv4PrefixList\n   ip-prefix 0.0.0.0/0 le 32 \n  !\n !\n!\napply-policy\n site-list WEST-BRANCHES\n  control-policy WEST-BRANCHES-SITES-CP out\n !\n site-list EAST-BRANCHES\n  control-policy EAST-BRANCHES-SITES-CP out\n !\n site-list EAST-HUB\n  control-policy BGP-CORE-EAST-HUB-CP out\n !\n site-list WEST-HUB\n  control-policy BGP-CORE-WEST-HUB-CP out\n !\n!\n</code></pre>"},{"location":"task1/#step-2-review-bfd-tunnels","title":"Step 2: Review BFD Tunnels","text":"<p>Next, you'll examine the BFD tunnels from the spoke sites. A spoke site in west region, site 5000 will not have BFD tunnel to spoke sites in east region, such as site 6000, and site 7000. You can either utilize the Manager Real Time UI option to confirm TLOCs and BFD sessions, or opt to SSH into the WAN Edges and execute command lines via an SSH terminal. For SSH access, you can leverage mRemoteNG on your desktop.  </p> <ul> <li> <p>From the SD-WAN Manager navagination bar, click Monitor &gt; Device. Locate EDGE-BRANCH-3-01, click on the device and choose Real Time as shown in the screenshot below.  </p> </li> <li> <p>In the Device Options field, enter OMP Received TLOCS. As you can see, there are no TLOCs to any site in the East region and therefore no tunnels to any sites in the East region either.  </p> </li> </ul> <p> </p> <ul> <li>We can confirm this by looking for BFD Sessions in the Device Options field.  </li> </ul> <p>We don\u2019t see East TLOC\u2019s IPs like 1.1.60.1, 1.1.70.1, 1.1.202.1 or 1.1.202.2 nor BFD tunnels against their Site IDs 202,6000 and 7000 </p> <p> </p>"},{"location":"task1/#step-3-review-ip-route","title":"Step 3: Review IP Route","text":"<p>Next, you'll examine the route tables from the spoke sites. A spoke site in west region (site 3000, 4000, 5000) doesn't have direct tunnel to spoke site in east region (site 6000,7000), but it learns east region spokes' prefixes with next hop pointing to west hubs (site 201).  </p> <ul> <li>In the Device Options field, enter IP route.  </li> <li>As you can see, even though it doesn't have tunnels towards the East sites, it has prefixes for such sites but pointing to the West Hubs (Site 201) TLOCs IPs instead of the originators.  </li> </ul> <p> </p>"},{"location":"task1/#step-4-review-path-between-spoke-sites","title":"Step 4: Review Path between spoke sites","text":"<p>To confirm the path for communication between spokes in different regions. Run traceroute and ping to test reachability of ubuntu hosts between branch sites in different regions.  </p> <ul> <li>Click mRemoteNG  on your desktop, select Site-3000-VPN-10-Ubun and open RDP session to the host with password C1sco12345. Run ping and traceroute to Ubuntu host in Site 6000 with IP 10.60.1.101.   </li> </ul> <p>Note</p> <p>Leave this ping running to identify any discruption during the migration in the incoming takss.</p> <p> </p> <ul> <li> <p>From the trace above, even though site 3000 and site 6000 have the Public-Internet transport in common, they do not communicate directly to each other. That is because the active Control Policy forces traffic going through the Hubs and then the BGP Core as highlighted in red in the trace.  </p> </li> <li> <p>Next, let's check the route table on West hub site BR-WEST-1. Go to the Manager GUI and then go to Monitor &gt; Devices &gt; BR-WEST-1 (1.1.201.1) &gt; Real Time and look up for IP route with the VPN 10 filter.  </p> </li> </ul> <p> </p> <ul> <li>As you see from the route table, the prefixes from East Regions are learned from BGP core. </li> </ul>"},{"location":"task2/","title":"Task 2 - Prepare MRF Migration","text":"<p>In this task, you will perform the following prerequisites before migrating from flat SD-WAN fabric to MRF.  </p> <ul> <li>Enable MRF  </li> <li>Creat regions  </li> <li>Provision Controllers for regions  </li> </ul>"},{"location":"task2/#step-1-enable-mrf","title":"Step 1: Enable MRF","text":"<p>In this step, you will enable MRF on vManage.  </p> <p>Info</p> <p>The MRF feature has been pre-enabled for this lab. This section is for your review of the workflow </p> <ul> <li>Click SD-WAN Manager navagination bar, go to Administration &gt; Settings. and confirm that the Multi-Region Fabric setting is enabled (By default is disabled).  </li> </ul> <p></p>"},{"location":"task2/#step-2-create-regions","title":"Step 2: Create Regions","text":"<p>After enabling MRF, the subsequent step involves creating the regions. For this lab, we'll establish two regions: EAST-REGION and WEST-REGION. Upon creation, the system automatically assigns a Region ID. In this lab, WEST-REGION has been assigned with Region ID 1, and EAST-REGION has been assigned Region ID 2.  </p> <p>Info</p> <p>The Regioins has been pre-enabled for this lab. This section is for your review of the workflow  </p> <ul> <li>Go to Configuration &gt; Network Hierarchy and you should see that the EAST-REGION and WEST-REGION have been pre-configured.  </li> </ul> <p></p>"},{"location":"task2/#step-3-provision-controllers-for-regions","title":"Step 3: Provision Controllers for Regions","text":"<p>In MRF, vSmart controller is assigned to specific region. Based on the size of the deployment, the vSmart controller can be dedicated for a region or for a group of regions. For this lab, you will have controllers assigned as shown below:  </p> <ul> <li>Controller-1 (1.1.1.3) as dedicated Controller for WEST-REGION (1).  </li> <li>Controller-2 (1.1.1.4) as dedicated Controller for EAST-REGION (2).  </li> <li>Controller-3 (1.1.1.5) as dedicated Controller for the Core Region (0).  </li> <li>Controller-4 (1.1.1.6) is the default/flat existing Controller serving the whole overlay.  </li> </ul> <p>Info</p> <p>The controllers have been pre-configured for this lab. This section is for your review of the workflow</p> <ul> <li> <p>The controller is assigned to the region by configuring Region ID List on controller System feature template. </p> </li> <li> <p>Go to Configuration &gt; Template &gt; Feature Templates, type SYSTEM_FT in the seach field, and you will see 4 pre-configured Controllers feature templates, one for each controller.  </p> </li> </ul> <p></p> <ul> <li> <p>Click the Devices Attached of each controller system ft, you will see the controllers are attached to the feature templates as planned.  </p> <ul> <li>CONTROLLER-1_SYSTEM_FT for Controller-1 (1.1.1.3)  </li> <li>CONTROLLER-2_SYSTEM_FT for Controller-1 (1.1.1.4)  </li> <li>CONTROLLER-3_SYSTEM_FT for Controller-1 (1.1.1.5)  </li> <li>CONTROLLER-4_SYSTEM_FT for Controller-1 (1.1.1.6)  </li> </ul> </li> <li> <p>Click the ... to view each of the controller system feature template.  </p> </li> </ul> <p>CONTROLLER-1_SYSTEM_FT </p> <p>CONTROLLER-2_SYSTEM_FT </p> <p>CONTROLLER-3_SYSTEM_FT </p> <p>CONTROLLER-4_SYSTEM_FT </p> <ul> <li> <p>After assigning distributed controllers for regions, all WAN Edges in the overlay remain un-assigned to any region, with **Controller-4(1.1.1.6) serving as the default controller for the entire overlay. You can verify that by checking the controller control connections of all WAN Edges.  </p> </li> <li> <p>Go to Monitor &gt; Devices and look the vSmart Control column.  </p> </li> </ul> <p> </p> <p>Info</p> <p>If output shows 0 control connection, please perform Rediscovery Network to show the correct outputs.  </p> <ul> <li>You can also verify this by going to Monitor &gt; Devices; select a device and then look up for OMP peers with the Real Time function.  </li> </ul> <p>For instance, EDGE-BRANCH-3-01 shows only one OMP peer with Controller-4 showing Region ID as None.  </p> <p> </p>"},{"location":"task3/","title":"Task 3 - Enable Migration Mode on Edge Routers","text":"<p>Enabling Migration Mode allows WAN Edges to participate in regional controllers while maintaining their current OMP peers with the default controllers. This must be enabled on all WAN Edges before the MRF migration.  </p> <p>In this task, you will enable Migration Mode on all Edge Routers for Site 1010, Site 1020, Site 3000, Site 4000, Site 5000, Site 6000, and Site 7000. In the next task, you will enable Migration Mode on all Border Routers.  </p>"},{"location":"task3/#step-1-create-new-systen-feature-template-for-west-edge-devices","title":"Step 1: Create new Systen Feature Template for West Edge Devices","text":"<ul> <li>Go to Configuration &gt; Templates &gt; Feature templates &gt; Add Template, select C8000v and Cisco System.</li> </ul> <ul> <li> <p>Name it as cEDGE_EDGE-WEST_SYSTEM_FT and define only the next parameters as follows:</p> <ul> <li>Location: \u201cDevice Specific\u201d</li> <li>Console Baud Rate: 115200</li> <li>Role: Edge Router</li> <li>Enable Migration Mode to Multi-Region Fabric: Enable</li> <li>Latitude: \u201cDevice Specific\u201d</li> <li>Longitude: \u201cDevice Specific\u201d</li> </ul> </li> </ul> <p>Note</p> <p>Location, Console Baud Rate, Latitude and Longitude parameters are not mandatory for MRF, however we define them for lab consistency.</p> <p></p>"},{"location":"task3/#step-2-assign-feature-template-to-west-edge-devices","title":"Step 2: Assign Feature Template to West Edge Devices","text":"<p>Assign the System Feature template named cEDGE_EDGE-WEST_SYSTEM_FT, created in previouse step, to all West sites and the corresponding Device Templates, which are:</p> <ul> <li>cEDGE_DC_DT </li> <li>cEDGE_SITE-3000_DT</li> <li>cEDGE_SITE-4000_DT</li> <li>cEDGE_SITE-5000_DT</li> </ul> <p></p> <ul> <li>The lab guide below shows the steps for cEDGE_DC_DT Device Template, and you need to repeat the steps for all other West Sites's device templates mentioned above.  </li> <li>Click on the 3 dots and then \u2018edit\u2019.</li> </ul> <p></p> <ul> <li>Next in \u2018Cisco System\u2019 select the cEDGE_EDGE-WEST_SYSTEM_FT.</li> </ul> <p></p> <ul> <li>Click \u2018Update\u2019 and you should see the next screen with all 4 DC devices with a little green checkmark.</li> </ul> <p></p> <ul> <li>Click \u2018Next\u2019 and should see the next configuration being applied to all 4 DC devices. </li> </ul> <p></p> <ul> <li>Finally click \u2018Configure Devices\u2019 to push the new configuration.</li> </ul> <p>Warning</p> <p>Repeat the above steps to apply the same new feature template to cEDGE_SITE-3000_DT, cEDGE_SITE-4000_DT and cEDGE_SITE-5000_DT.</p>"},{"location":"task3/#step-3-create-new-systen-feature-template-for-east-edge-devices","title":"Step 3: Create new Systen Feature Template for East Edge Devices","text":"<ul> <li>Go to Configuration &gt; Templates &gt; Feature templates &gt; Add Template, select C8000v and Cisco System.</li> </ul> <ul> <li> <p>Name it as cEDGE_EDGE-EAST_SYSTEM_FT and define only the next parameters as follows:</p> <ul> <li>Location: \u201cDevice Specific\u201d</li> <li>Console Baud Rate: 115200</li> <li>Role: Edge Router</li> <li>Enable Migration Mode to Multi-Region Fabric: Enable</li> <li>Latitude: \u201cDevice Specific\u201d</li> <li>Longitude: \u201cDevice Specific\u201d</li> </ul> </li> </ul> <p> </p> <p>Click 'Save'.</p> <p>Note</p> <p>Location, Console Baud Rate, Latitude and Longitude parameters are not mandatory for MRF, however we define them for lab consistency.</p>"},{"location":"task3/#step-4-assign-feature-template-to-east-edge-devices","title":"Step 4: Assign Feature Template to East Edge Devices","text":"<p>Assign the System Feature template named cEDGE_EDGE-EAST_SYSTEM_FT, created in previouse step, to all East sites and the corresponding Device Templates, which are:</p> <ul> <li>cEDGE_SITE-6000_DT </li> <li>cEDGE_SITE-7000_DT</li> </ul> <p></p> <ul> <li>The lab guide below shows the steps for cEDGE_SITE-6000_DT Device Template, and you need to repeat the steps for the other East Sites's device templates cEDGE_SITE-7000_DT.  </li> <li>Click on the 3 dots and then \u2018edit\u2019.</li> </ul> <p></p> <ul> <li>Next in Cisco System select the cEDGE_EDGE-EAST_SYSTEM_FT</li> </ul> <p></p> <ul> <li>Click \u2018Next\u2019 and should see the next configuration being applied to the EDGE-BRANCH-6-01 (1.1.60.1).  </li> <li>Finally click \u2018Configure Devices\u2019 to push the new configuration.</li> </ul> <p></p> <p>Warning</p> <p>Repeat the above steps to apply the same new feature template to cEDGE_SITE-7000_DT.  </p>"},{"location":"task3/#step-5-validate-defaultflat-controller","title":"Step 5: Validate default/flat Controller","text":"<p>You have enabled Migration Mode on all Edge Routers, but since you have not assigned region for reach Edge Router yet, the Edge Router will only peer with default/flat controller.  </p> <ul> <li> <p>Now in Manager UI, go to Monitor &gt; Devices &gt; EDGE-BRANCH-3-01 &gt; Real Time and look up for OMP Peers in the search bar.</p> </li> <li> <p>As you can see the EDGE-BRANCH-3-01 has only one OMP peer, which is with Controller-4 (1.1.1.6) serving as default/flat Controller for the entire overlay. Note that the Region ID is \u2018None\u2019; this will change in Task 5.</p> </li> </ul> <p> </p> <ul> <li>Verify OMP Peers from Edge Routers in EAST region and you will see only one OMP peer with the deault/flat controller.  </li> </ul>"},{"location":"task4/","title":"Task 4 - Enable MRF on Border Routers","text":"<p>In this task you will enable Migration Mode on all Border Routers. In addtion, you will apply BGP Migration Community and MRF on all Border Routers.</p> <p>This BGP Community is needed to avoid routing domain loops with the OMP prefixes on the Default/flat Controller being redistributed into the BGP Core and then re-originated and redistributed back again, but now to the Region-aware Controller as shown in the next Diagram. </p> <p>This is because Region-aware OMP routes are preferred over default region OMP routes. </p> <p>Note</p> <p>The BGP Community we will be using is 12 in an additive manner on all Border Routers and PE routers. The same community will be used for the for the OMP to BGP redistribution.  </p> <p></p>"},{"location":"task4/#step-1-enable-draft-mode-on-all-border-routers","title":"Step 1: Enable \"Draft Mode\" on all Border Routers","text":"<p>Enabling MRF on Border Router requires multiple feature templates changes, which are traffic disruptive. To mitigate the impact, you will enable \u201cDraft Mode\u201d on all Border routers at Site 201 and Site 202. This will minimize the disruption that these changes might otherwise cause.  </p> <ul> <li>Go to Configuration &gt; Templates and enable \u201cDraft Mode\u201d on both cEDGE_SITE-201_DT and EDGE_SITE-202_DT device templates as follows.</li> </ul> <p></p> <p></p>"},{"location":"task4/#step-2-apply-bgp-migration-community","title":"Step 2: Apply BGP Migration Community","text":"<ul> <li>Go to Configuration &gt; Templates &gt; Feature Templates, look up for the cEDGE_HUB_VPN-10_BGP_FT feature template and edit it.</li> </ul> <ul> <li>Make \u2018Propagate Community\u2019 Global on as shown below.</li> </ul> <p>*Under \u2018Unicast Address Family\u2019, click on pencil icon to edit the OMP redistribution</p> <p></p> <ul> <li>Add MATCH-MIG-COMM as the Route Policy.</li> </ul> <p></p> <ul> <li> <p>Click 'Save Changes'.</p> </li> <li> <p>Now under the \u2018Neighbor\u2019 section and click on the pencil icon to edit it.</p> </li> </ul> <p></p> <ul> <li>Make \u2018Route Policy Out\u2019 Global \"on\" to enable out bound route policy. In the \u2018Policy Name\u2019 field enter route policy APPEND-MIG-COMM which is pre-configured on the localized policy for simplicity.</li> </ul> <p></p> <ul> <li>Click \u2018Save Changes\u2019, \u2018Update\u2019 then \u2018Next\u2019 and then \u2018Configure Devices\u2019 to generate the draft configurations for all four East and West border routers.</li> </ul> <p></p> <ul> <li>You should see these status and messages for the draft configuration generated for all 4 devices.</li> </ul> <p></p>"},{"location":"task4/#step-3-configure-mrf-on-west-border-routers","title":"Step 3: Configure MRF on WEST Border Routers","text":"<ul> <li>Go to Configuration &gt; Templates &gt; Feature Templates and create a new C8000v \u2018Cisco System\u2019 feature template and name it cEDGE_BORDER-WEST-201_SYSTEM_FT</li> </ul> <ul> <li> <p>Define all the next parameters as follows:</p> <ul> <li>Location: \u201cDevice Specific\u201d</li> <li>Console Baud Rate: 115200</li> <li>Region: West-Region</li> <li>Role: Border Router</li> <li>Enable Migration Mode to Multi-Region Fabric: Enable from BGP Core</li> <li>Migration BGP Community: 12</li> <li>Latitude: \u201cDevice Specific\u201d</li> <li>Longitude: \u201cDevice Specific\u201d</li> </ul> </li> </ul> <p>Note</p> <p>Location, Console Baud Rate, Latitude and Longitude parameters are not mandatory for MRF, however we define them for lab consistency.  </p> <p> </p> <ul> <li> <p>Click \u2018Save\u2019.</p> </li> <li> <p>In Device Templates look up for the cEDGE_SITE-201_DT device template and click on edit</p> </li> </ul> <p></p> <ul> <li>In the \u2018System\u2019 section now select the cEDGE_BORDER-WEST-201_SYSTEM_FT we previously created, then click \u2018update\u2019 and push the change.  </li> <li>This will configure BR-WEST-1 and BR-WEST-2 as the border routers role facing the WEST-REGION.</li> </ul> <p></p> <ul> <li>Click \u2018Update\u2019, then \u2018Next\u2019 and confirm in the \u2018Config Diff\u2019 section that now both west hubs are assigned to WEST-REGION (1), acting as Border Routers and with the migration mode enabled-from-bgp-core.  </li> <li>Finally click \u2018Configure Devices\u2019 to push the changes.</li> </ul> <p></p> <p>Info</p> <p>Because the cEDGE_SITE-201_DT device template is still in draft mode, it won\u2019t make any change until we disable draft mode.</p>"},{"location":"task4/#step-4-configure-mrf-on-east-border-routers","title":"Step 4: Configure MRF on EAST Border Routers","text":"<p>Now, let\u2019s repeat the same process for the East Border routers.  </p> <ul> <li>Go to Configuration &gt; Templates &gt; Feature Template, create a new C8000v \u2018Cisco System\u2019 feature template and name it cEDGE_BORDER-EAST-202_SYSTEM_FT.</li> </ul> <p></p> <ul> <li> <p>Define all the parameters as follows:</p> <ul> <li>Location: \u201cDevice Specific\u201d</li> <li>Console Baud Rate: 115200</li> <li>Region: East-Region</li> <li>Role: Border Router</li> <li>Enable Migration Mode to Multi-Region Fabric: Enable from BGP Core</li> <li>Migration BGP Community: 12</li> <li>Latitude: \u201cDevice Specific\u201d</li> <li>Longitude: \u201cDevice Specific\u201d</li> </ul> </li> </ul> <p>Note</p> <p>Location, Console Baud Rate, Latitude and Longitude parameters are not mandatory for MRF, however we define them for lab consistency.  </p> <p> </p> <ul> <li>In Device Templates look up for the cEDGE_SITE-202_DT device template and click on \u2018edit\u2019</li> </ul> <p></p> <ul> <li>In the \u2018System\u2019 section now select the cEDGE_BORDER-EAST-202_SYSTEM_FT we previously created. This will configure BR-EAST-1 and BR-EAST-2 as the border routers role facing the EAST-REGION.</li> </ul> <p></p> <ul> <li>Click \u2018Update\u2019, then \u2018Next\u2019 and confirm in the \u2018Config Diff\u2019 section that now both west hubs are assigned to EAST-REGION (2), acting as Border Routers and with the migration mode enabled-from-bgp-core.  </li> <li>Finally click \u2018Configure Devices\u2019 to push the changes.</li> </ul> <p></p> <p>Info</p> <p>Because the cEDGE_SITE-202_DT device template is still in draft mode, it won\u2019t make any change until we disable draft mode.  </p> <ul> <li>Next enable the Private1 TLOC as Core transport on all Border devices.  </li> <li>Go to Configuration &gt; Templates &gt; Feature Templates; look up for the feature template cEDGE_SITE-20X_VPN-0_PRIVATE1_CHILD-IF_FT which is shared by all Border devices, and edit it.  </li> </ul> <p></p> <ul> <li>Under the \u2018Tunnel\u2019 section, scroll down and under \u2018advance options\u2019 make Global on  the \u2018Enable Core Region\u2019 parameter.</li> </ul> <p></p> <ul> <li>Click \u2018Update\u2019, \u2018Next\u2019 and \u2018Configure Devices\u2019. This enables Private1 TLOC to service the Core Region.</li> </ul> <p></p> <ul> <li>Finally click \u2018Configure Devices\u2019 to push configuration change. Because all Border routers are in \u201cDraft Mode\u201d, it won\u2019t make any change until we disable draft mode.</li> </ul>"},{"location":"task4/#step-5-disable-draft-mode-and-modify-control-policy","title":"Step 5: Disable \u201cDraft Mode\u201d and Modify Control Policy","text":"<ul> <li>Click mRemoteNG  on your desktop, select Site-3000-VPN-10-Ubun and open RDP session to the host with password C1sco12345. Run ping to Ubuntu host in Site 6000 with IP 10.60.1.101.  </li> <li> <p>Leave the ping running for connectivity test to measure the impact for this change.  </p> </li> <li> <p>Go to Configuration &gt; Templates and click \u2018Disable Draft Mode\u201d for cEDGE_SITE-201_DT and EDGE_SITE-202_DT to push all configs you did in step 1 to 4.</p> </li> </ul> <p></p> <p>Then click \u2018Disable\u201d on the pop-up window, then \u2018Next\u2019 and finally click \u2018Configure Devices\u2019 to push all changes</p> <p>Note</p> <p>This change will cause a minor churn in the network, therefore try to disable \u201cDraft Mode\u201d as fast as possible on both device templates to diminish the impact.</p> <p>Info</p> <p>You can look the packet loss % of ping test running on the Ubuntu Site-3000-VPN-10-Ubun host in Site 3000 </p> <p>( Repeat the same process to disable draft mode for EDGE_SITE-202_DT*.  )</p> <ul> <li>Verify the new OMP Peers on borders.  </li> <li> <p>Go to Monitor &gt; Devices &gt; BR-WEST-1 &gt; Real Time and look up for OMP Peers in the search bar.</p> </li> <li> <p>Because of the previous configurations on west hubs, you can see OMP session to Controller-1 (1.1.1.3) for WEST-REGION (1), Controller-3 (1.1.1.5) for Core Region (0)  and the default/flat Controller-4 (1.1.1.6) that is being used for Migration.  </p> </li> </ul> <p></p> <ul> <li>Verify East Border devices, such as BR-EAST-1 and you will see a similar OMP peering with the exception of the  Controller-2 (1.1.1.4) that serves the EAST-REGION (2). </li> </ul> <p> </p> <ul> <li> <p>Now modify the Centralized Control Policy to allow the Border routers to receive the Private1 TLOCs of each other. This creates a fabric for the Core Region.  </p> </li> <li> <p>Go to Configuration &gt; Policies and activate the pre-configured OMP_CORE_TLOCS_POLICY Centralized Policy.  </p> </li> </ul> <p></p> <ul> <li>Click \u2018Activate\u2019.</li> </ul> <p>Note</p> <p>Review the Centralized Policy you just activated, where you now advertise the Core Private1 TLOCs between Border routers, besides its respective Regional Hub &amp; Spoke logic.</p>"},{"location":"task5/","title":"Task 5 - Enable MRF on Edge Routers","text":"<p>In this task, you will assign regions for the West and East Edge Routers in Site 1010, Site 1020, Site 3000, Site 4000, Site 5000, Site 6000, and Site 7000.</p> <p>In Task 3, you enabled migration mode on all Edge Routers without assigning a region. You verified that the Edge Routers only peer with the default/flat controller. After completing this task, you will see the Edge Routers form OMP peers with the new regional controller in addition to the existing OMP peer with the default/flat controller.  </p>"},{"location":"task5/#step-1-enable-region-on-west-edge-devices","title":"Step 1: Enable Region on West Edge devices","text":"<ul> <li>Go to Configuration &gt; Templates &gt; Feature templates; look up for the cEDGE_EDGE-WEST_SYSTEM_FT feature template we created in task 3 and edit it.</li> </ul> <ul> <li>Make Global on the \u2018Region\u2019 parameter to assign all devices attached to this feature template to the WEST-REGION.  </li> <li>This will cause all devices in the West region to peer with the Controller-1 (1.1.1.3) for WEST-REGION (1), in addition to peering with the default/flat Controller-4 (1.1.1.6) that's used for Migration.  </li> </ul> <ul> <li>Click \u2018Update\u2019, then \u2018Next\u2019.</li> </ul> <ul> <li>Finally, click \u2018Configure Devices\u2019 to apply this change to all devices in the West Region. </li> </ul>"},{"location":"task5/#step-2-enable-region-on-east-edge-devices","title":"Step 2: Enable Region on East Edge devices","text":"<ul> <li>Repeat the same process for East Edge devices </li> <li>Go to Configuration &gt; Templates &gt; Feature templates; look up for the cEDGE_EDGE-EAST_SYSTEM_FT feature template and edit it.  </li> </ul> <ul> <li>Make Global on the \u2018Region\u2019 parameter to assign all devices attached to this feature template to the EAST-REGION.  </li> <li>This enables all devices in the West region to peer to the Controller-1 (1.1.1.4) for EAST-REGION (2), in addition to peering with the default/flat Controller-4 (1.1.1.6) that's used for Migration.  </li> </ul> <ul> <li>Click \u2018Update\u2019, then \u2018Next\u2019.</li> </ul> <ul> <li>Finally click \u2018Configure Devices\u2019 to apply this change to all devices in the East Region.  </li> </ul>"},{"location":"task5/#step-3-verify-omp-peers-on-edge-devices","title":"Step 3: Verify OMP Peers on Edge Devices","text":"<p>Remember in task3, after enabling migration mode on Edge devices, the Edge device still only peer with the default/flat Controller-4 (1.1.1.6). Now, you should see the respect regional controller in addition to default/flat controller in OMP peer.  </p> <ul> <li>Go to Monitor &gt; Devices &gt; EDGE-BRANCH-3-01 &gt; Real Time and look up for OMP Peers in the search bar.  </li> </ul> <p></p> <ul> <li>Go to Monitor &gt; Devices &gt; EDGE-BRANCH-6-01 &gt; Real Time and look up for OMP Peers in the search bar.  </li> </ul> <p></p>"},{"location":"task6/","title":"Task 6 - MRF Migration Clean Up","text":"<p>Now that you have all Edge Routers and Border Routers peered with regional controllers, and completed the MRF migration. In this task you will clean up the temporary policy and disable migration mode.  </p> <p>After all devices are moved to MRF, the flat/default controller can be re-purposed to other region. In this lab, you will re-purpose Controller-4 to region 0's controller.  </p>"},{"location":"task6/#step-1-remove-route-map","title":"Step 1: Remove route-map","text":"<ul> <li>Go to Configuration &gt; Templates &gt; Feature templates, look up for cEDGE_HUB_VPN-10_BGP_FT and edit to remove route-map you completed in task 4.  </li> </ul> <ul> <li>Under UNICAST ADDRESS FAMILY, click pencil to edit the OMP redistribution policy.  </li> </ul> <ul> <li>Remove associated the route policy by changing it to default, and Save Changes </li> </ul> <ul> <li>Under NEIGHBOR section, click pencil to edit the policy associate the BGP neighbor.  </li> </ul> <ul> <li>Remove associated outbound route policy by changing Route Policy Out to Off.  </li> </ul> <ul> <li>Click Save Changes then Update to trigger the configuration change. Click Configure Devices to remove the loop prevention BGP route policy you applied on task 4 on all 4 Border Routers.  </li> </ul>"},{"location":"task6/#step-2-disable-migration-mode","title":"Step 2: Disable Migration Mode","text":"<ul> <li>Go to Configuration &gt; Templates &gt; Feature templates, look up for cEDGE_BORDER-WEST-201_SYSTEM_FT and edit it.  </li> </ul> <ul> <li>Change Enable Migration Mode to Multi-Region Fabric field to Default. This will disable the migration mode and therefor the West Border router will keepthe OMP session to West Region aware controller-1 (1.1.1.3), and the Core region Controller-3 (1.1.1.5), but will remove the OMP peering to default/flat overlay Controller-4 (1.1.1.6) used for the migration.  </li> </ul> <ul> <li>Click Update, then Next and thenn Configure Devices to disable the migration mode on both West Border routers.</li> </ul> <p>Repeat the same process to disable Migration Mode for East Border routers.</p> <ul> <li>Go to Configuration &gt; Templates &gt; Feature templates, look up for cEDGE_BORDER-EAST-202_SYSTEM_FT and edit it.  </li> </ul> <p> </p> <ul> <li>Change Enable Migration Mode to Multi-Region Fabric field to Default. This will disable the migration mode and therefor the East Border router will keepthe OMP session to West Region aware controller-2 (1.1.1.4), and the Core region Controller-3 (1.1.1.5), but will remove the OMP peering to default/flat overlay Controller-4 (1.1.1.6) used for the migration.  </li> </ul> <p> </p> <ul> <li>Click Update, then Next and thenn Configure Devices to disable the migration mode on both East Border routers.</li> </ul> <p>Repeat the same process to disable Migration Mode for West Edge routers.  </p> <ul> <li>Go to Configuration &gt; Templates &gt; Feature templates, look up for cEDGE_EDGE-WEST_SYSTEM_FT and edit it.  </li> </ul> <p> </p> <ul> <li>Change Enable Migration Mode to Multi-Region Fabric field to Default. This will disable the migration mode and therefor the West Region Edge devices will keep the OMP session to West Region aware controller-1 (1.1.1.3), and remove the OMP peering to default/flat overlay Controller-4 (1.1.1.6) used for the migration.  </li> </ul> <p> </p> <ul> <li>Click Update, then Next and thenn Configure Devices to disable the migration mode on all West Edge routers.   </li> </ul> <p>Repeat the same process to disable Migration Mode for East Edge routers.  </p> <ul> <li>Go to Configuration &gt; Templates &gt; Feature templates, look up for cEDGE_EDGE-EAST_SYSTEM_FT and edit it.  </li> </ul> <p> </p> <ul> <li>Change Enable Migration Mode to Multi-Region Fabric field to Default. This will disable the migration mode and therefor the East Region Edge devices will keep the OMP session to West Region aware controller-2 (1.1.1.4), and remove the OMP peering to default/flat overlay Controller-4 (1.1.1.6) used for the migration.  </li> </ul> <p> </p> <ul> <li>Click Update, then Next and thenn Configure Devices to disable the migration mode on all East Edge routers.  </li> </ul>"},{"location":"task6/#step-3-re-purpose-default-controller","title":"Step 3: Re-purpose default controller","text":"<p>After disable migration mode on all border and Edge devices, the default/flat overlay Controller-4 (1.1.1.6) is no longer peering with any device. In this step, you will re-purpose reposition this controller to the Core region for redundancy.  </p> <p>Note</p> <p>This is an optional task.</p> <ul> <li>Go to Configuration &gt; Templates &gt; Device Templates, look up for the device template of controller for core region CONTROLLER-3_DT and Attach Devices.  </li> </ul> <p> </p> <ul> <li>Select Controller-4 from Available Devices window move it to Selected Devices window, then click 'Attach' and then 'Next'. </li> </ul> <p> </p> <ul> <li>Configure Devices to push the configuration. This moves Controller-4 to Core region.  </li> </ul> <p> </p>"},{"location":"task6/#step-4-de-active-current-centralized-policy-and-remove-bgp-core","title":"Step 4: De-active current Centralized Policy and remove BGP core","text":"<p>As MRF by default makes inte-region connections via core region, the centralized policy configured in flat fabric becomes unnecessary. Let's deactive the current centralized policy and remove the BGP core between borders.  </p> <p>Note</p> <p>In this lab, no service in the core region hence you will remove the service VPN and BGP in core region.   </p> <ul> <li> <p>Go to Configuration &gt; Policies and deactivate the current active Centralized Policy OMP_CORE_TLOCS_POLICY </p> </li> <li> <p>Click Deactivate and Deactivate once again.  </p> </li> </ul> <p> </p> <ul> <li> <p>You can remove the BGP core by shutting down the service VPN 10 interfaces on all Hubs that were used for the BGP core. This ensures the inter-region communication uses the Fabric we created at the Core with the Private1 TLOCs.  </p> </li> <li> <p>Go to Configuration &gt; Templates &gt; Device Templates; look up for cEDGE_SITE-201_DT device template and now click on Change Device Values.  </p> </li> </ul> <p> </p> <ul> <li> <p>Scroll to the right and mark the checkbox or click on the three dots to shut down the VPN-10_CHILD_IF-1 interfaces on both Border Routers BR-WEST-1 and BR-WEST-2.  </p> </li> <li> <p>Click Next and then Configure Devices.  </p> </li> </ul> <p> </p> <p>Note</p> <p>Repeat the same process for cEDGE_SITE-202_DT Device Template to shutdown VPN 10 interfaces on BR-EAST-1 and BR-EAST-2.      </p> <p>Now, Let's verify the connectivity between Site 3000 and Site 6000 from Ubuntu VM and check the path from traceroute.  </p> <ul> <li> <p>Open mRemoteNG RDP to host Site-3000-VPN-10-Ubun. Ping and trace the Ubuntu host located in Site 6000 with IP 10.60.1.101 </p> </li> <li> <p>As we can see below, both are still reachable and the traffic is still going through the Fabric we created in the Core, but now without a such complex Control Policy.  </p> </li> </ul> <p> </p> <p>Success</p>"},{"location":"task6/#congratulations-you-have-fully-migrated-your-overlay-from-a-regional-hub-spoke-using-control-policy-to-a-multi-region-fabric-without-control-policy","title":"Congratulations, you have fully migrated your overlay from a Regional Hub &amp; Spoke using Control Policy to a Multi-Region Fabric without Control Policy.","text":""},{"location":"task7/","title":"Task 7 - MRF Secondary Region","text":"<p>The Secondary Region is a feature within Multi-Region Fabric that provides a direct path between sites in different regions. Depending on the requirements, this path over 2nd region can serve as primary path between sites in different regions, or backup path or ECMP.  </p> <p>In this task you will create a Secondary Region between the West Site 5000 and the East Sites 6000 and 7000 as shown in the diagram below.</p> <p> </p> <ul> <li>First, RDP into the Ubuntu Site-5000-VPN-10-Ubun host in Site 5000 using the mRemoteNG client and the ping and trace the IP 10.60.1.101 that lives in Site 6000.</li> </ul> <p> </p> <p>As you can see, it is reachable through the Fabric in the Core now.</p>"},{"location":"task7/#step-1-create-secondary-region","title":"Step 1: Create Secondary Region","text":"<ul> <li>Go to Configuration &gt; Network Hierarchy and in Global click on ... and select \u2018Add Node\u2019.</li> </ul> <ul> <li>Select the Region Type and name it as SECONDARY-REGION</li> </ul> <ul> <li>Click Add.  </li> </ul> <p>Note</p> <p>As with the primary West and East Region, now this Secondary region has been assigned with the Region ID 3 automatically by the system.</p>"},{"location":"task7/#step-2-create-transport-interface-feature-templates-with-secondary-region","title":"Step 2: Create Transport Interface Feature Templates with Secondary Region","text":"<p>As you can see from the diagram above, the 2nd region will be enabled over both Piblic-Internet and MPLS transports. In this step, you will build two new feature templates for both transport interfaces with 2nd region enabled.  </p> <ul> <li>Go to Configuration &gt; Templates &gt; Feature Templates and look up for the existing cEDGE_SITE-ALL_VPN-0_PUB-INET_IF_FT feature template and click 'Copy' to clone it.</li> </ul> <p> </p> <ul> <li>Name it as cEDGE_SITE-PRI_AND_SEC-REGIONS_VPN-0_PUB-INET_IF_FT and click \u2018Copy\u2019</li> </ul> <p> </p> <ul> <li>Now, look up for the template you just created cEDGE_SITE-PRI_AND_SEC-REGIONS_VPN-0_PUB-INET_IF_FT and edit it.</li> </ul> <p> </p> <ul> <li>Go to the Tunnel section and under  \u2018Advanced Options\u2019, enable \u2018Secondary Region\u2019 as Shared Between Primary and Secondary Regions and click \u2018update\u2019.</li> </ul> <p> </p> <ul> <li> <p>Click 'Update'.</p> </li> <li> <p>Go to Configuration &gt; Templates &gt; Feature and look up for the existing cEDGE_SITE-ALL_VPN-0_MPLS_IF_FT feature template to clone it.</p> </li> </ul> <p> </p> <ul> <li>Name it as cEDGE_SITE-PRI_AND_SEC_REGIONS_VPN-0_MPLS_IF_FT</li> </ul> <p> </p> <ul> <li> <p>Click \u2018Copy\u2019.</p> </li> <li> <p>Now, look up again for the template you just created cEDGE_SITE-PRI_AND_SEC_REGIONS_VPN-0_MPLS_IF_FT and edit it.</p> </li> </ul> <p> </p> <ul> <li>Define the Interface Name as a variable (this because it will be used for Site7000 that uses a different interface for the MPLS TLOC).</li> </ul> <p> </p> <ul> <li>Go to the \u2018Tunnel\u2019 section and under \u2018Advanced Options\u2019, enable \u2018Secondary Region\u2019 as Shared Between Primary and Secondary Regions</li> </ul> <p> </p> <ul> <li>Click 'Update'.</li> </ul>"},{"location":"task7/#step-3-create-an-omp-feature-template-to-influenciate-the-omp-best-path-algorithm","title":"Step 3: Create an OMP Feature Template to influenciate the OMP Best Path Algorithm","text":"<p>By default, the path over 2nd region is prefered shorter path, because it provides the direct path for sites in different region. In this step, you will change this default behavior to allow equal cost multi path over direct path and core region path.  </p> <ul> <li> <p>Go to Configuration &gt; Templates &gt; Feature and let\u2019s copy now the existing cEDGE_ALL_OMP_FT feature template. </p> </li> <li> <p>Name it as cEDGE_OMP_PRI_AND_SEC_REGIONS_FT</p> </li> </ul> <p></p> <ul> <li> <p>Click \u2018Copy\u2019.</p> </li> <li> <p>Once created it look up for cEDGE_OMP_PRI_AND_SEC_REGIONS_FT and edit it.</p> </li> </ul> <p></p> <ul> <li>Go to the \u2018Best Path\u2019 section, and make Global on to enable the Ignore Region-Path Length During Best-Path Algorithm parameter, then click \u2018update\u2019. </li> </ul> <p></p> <ul> <li>Click 'Update'.  </li> </ul> <p>Info</p> <p>The default value is Off, and by default, OMP gives preference to a direct tunnel path over a hierarchical path because the direct path has fewer hops.  </p> <p>Note</p> <p>With this configuration, we disable the comparison of the number of hops, OMP applies equal-cost multi-path routing (ECMP) to all routes, and packets can use all available paths. </p>"},{"location":"task7/#step-4-enable-secondary-region-for-site-5000","title":"Step 4: Enable Secondary Region for Site 5000","text":"<p>In this step, you will update the device templates and enable Secondary Region on Site 5000.</p> <ul> <li> <p>Modify the Cisco System Feature template currently used by the Site 5000 edge router to participate in the secondary.  </p> </li> <li> <p>Go Configuration &gt; Templates &gt; Feature and look up for the cEDGE_EDGE-WEST_SYSTEM_FT and click \u2018Copy\u2019 </p> </li> <li> <p>Name it as cEDGE_PRI_AND_SEC_REGIONS-WEST_SYSTEM_FT.  </p> </li> </ul> <p></p> <ul> <li>Click \u2018Copy\u2019.  </li> </ul> <p></p> <ul> <li>Look up for the cEDGE_PRI_AND_SEC_REGIONS-WEST_SYSTEM_FT feature template you just created and click \u2018Edit\u2019  </li> </ul> <p></p> <ul> <li>Make Global on the \u2018Secondary Region\u2019 parameter and select SECONDARY-REGION from the dropdown menu.</li> </ul> <p></p> <ul> <li> <p>Click \u2018Update\u2019 to save the changes.</p> </li> <li> <p>Go to Configuration &gt; Templates &gt; Device Templates look up for the cEDGE_SITE-5000_DT device template and edit it.  </p> </li> </ul> <p></p> <ul> <li>In the \u2018Cisco System\u2019 section, select the feature template we previously created named cEDGE_PRI_AND_SEC_REGIONS-WEST_SYSTEM_FT</li> </ul> <p></p> <ul> <li>Under the \u2018Cisco OMP\u2019 section, select the cEDGE_OMP_PRI_AND_SEC_REGIONS_FT feature template we created in step 3.  </li> </ul> <p></p> <ul> <li>Under the \u2018Transport &amp; Management VPN\u2019 section, change the two Cisco VPN Interface Ethernet feature templates to the ones created in step 1 named cEDGE_SITE-PRI_AND_SEC-REGIONS_VPN-0_PUB-INET_IF_FT and cEDGE_SITE-PRI_AND_SEC_REGIONS_VPN-0_MPLS_IF_FT respectively.</li> </ul> <p></p> <ul> <li>Finally, click \u2018Update\u2019, and fill out the two new variables with GigabitEthernet2 and 10.2.11.2/24 as shown below. </li> </ul> <p></p> <ul> <li>Click \u2018Update\u2019 and you should see in the \u2018Config Diff\u2019 section all the next lines in green color being pushed to the device if you scroll down. </li> </ul> <p> </p> <ul> <li>After compare the diff, click \u2018Configure Devices\u2019 to push configuration.  </li> </ul>"},{"location":"task7/#step-5-enable-secondary-region-for-site-6000-and-7000","title":"Step 5: Enable Secondary Region for Site 6000 and 7000","text":"<p>In this step, you will update the device templates and enable Secondary Region on Site 6000 and site 7000. Again, for simplicity, let\u2019s copy the \u2018System\u2019 Feature template currently used by the Site 6000 and site 7000 to participate in the secondary.  </p> <ul> <li>Go to Configuration &gt; Templates &gt; Feature; look up for the cEDGE_EDGE-EAST_SYSTEM_FT and click \u2018Copy\u2019.</li> </ul> <p></p> <ul> <li>Name it  cEDGE_PRI_AND_SEC_REGIONS-EAST_SYSTEM_FT</li> </ul> <p></p> <ul> <li>Look up for cEDGE_PRI_AND_SEC_REGIONS-EAST_SYSTEM_FT feature template you just created and click \u2018Edit\u2019.</li> </ul> <p></p> <ul> <li>Make Global on the \u2018Secondary Region\u2019 parameter and select SECONDARY-REGION from the dropdown menu.</li> </ul> <p></p> <ul> <li> <p>Click \u2018Update\u2019.</p> </li> <li> <p>Update device template for Site 6000  </p> </li> <li> <p>Go to Configuration &gt; Templates &gt; Device Templates; look up for the cEDGE_SITE-6000_DT device template and edit it.</p> </li> </ul> <p></p> <ul> <li>Under \u2018Cisco System' section select the feature template cEDGE_PRI_AND_SEC_REGIONS-EAST_SYSTEM_FT.</li> </ul> <p></p> <ul> <li>Under \u2018Cisco OMP\u2019 section, select the cEDGE_OMP_PRI_AND_SEC_REGIONS_FT feature template. </li> </ul> <p></p> <ul> <li>Under the \u2018Transport &amp; Management VPN\u2019 section, change the two Cisco VPN Interface Ethernet feature templates to the ones created in step 2 named cEDGE_SITE-PRI_AND_SEC-REGIONS_VPN-0_PUB-INET_IF_FT</li> </ul> <p></p> <ul> <li> <p>Click \u2018Update\u2019, then \u2018Next\u2019.</p> </li> <li> <p>You should see the all the next lines in green color in the \u2018Config Diff\u2019 being pushed to the device if you scroll down.  </p> </li> </ul> <p> </p> <ul> <li> <p>Click \u2018Configure Devices\u2019 to push the configuration after compare the diff.  </p> </li> <li> <p>Let\u2019s repeat the same process to update device template for Site 7000.  </p> </li> <li> <p>Go to Configuration &gt; Templates &gt; Device Templates; look up for the cEDGE_SITE-7000_DT device template and edit.</p> </li> </ul> <p></p> <ul> <li>Under \u2018Cisco System\u2019 section select the cEDGE_PRI_AND_SEC_REGIONS-EAST_SYSTEM_FT feature template.</li> </ul> <p></p> <ul> <li>Under the \u2018Cisco OMP\u2019 section, select the cEDGE_OMP_PRI_AND_SEC_REGIONS_FT feature template.</li> </ul> <p></p> <ul> <li>Under the \u2018Transport &amp; Management VPN\u2019 section, change the two Cisco VPN Interface Ethernet feature templates to the ones created in step 2 named cEDGE_SITE-PRI_AND_SEC_REGIONS_VPN-0_MPLS_IF_FT.</li> </ul> <p></p> <ul> <li>Click \u2018Update\u2019, and fill out the two new variables with GigabitEthernet1 and 10.2.12.2/24 as shown below.</li> </ul> <p></p> <ul> <li>Click \u2018Update\u2019 and you should see in the \u2018Config Diff\u2019 section all the next lines in green color being pushed to the device if you scroll down. </li> </ul> <p> </p> <ul> <li>After compare the diff, click \u2018Configure Devices\u2019 to push configuration.</li> </ul>"},{"location":"task7/#step-6-make-controller-3-secondary-region-aware-and-validate","title":"Step 6: Make Controller-3 Secondary Region-aware and Validate","text":"<p>Sites Site 5000, Site 6000 and Site 7000 have been configured to participate in the SECONDARY-REGION (3). However there is no controller for secondary region yet.  </p> <p>In this step, you will configure Controller-3 (1.1.1.5) for secondary region.  </p> <ul> <li>Go to Configuration &gt; Templates &gt; Feature Templates and look up for the CONTROLLER-3_SYSTEM_FT feature template and edit it.</li> </ul> <p></p> <ul> <li>In the \u2018Region ID List\u2019 parameter, add the SECONDARY-REGION to serve this region besides the Core Region.</li> </ul> <p></p> <ul> <li>Click \u2018Update\u2019, then \u2018Next\u2019 and you should see the next in the \u2018Config Diff\u2019.</li> </ul> <p></p> <ul> <li>Click \u2018Configure Devices\u2019 to push the configuration.  </li> </ul> <p>Now, Site 5000 has connectivity to Site 6000 and Site 7000, and vice versa, through the Core Fabric and the Direct Path over the secondary region.</p> <p>Because you enabled \u2018Ignore Region-Path Length During Best-Path Algorithm\u2019 on the new OMP template in step 1, the system uses ECMP over all available paths, including the direct path and the path over the core region. This is beneficial in use cases where the requirement is to send non-critical traffic using lower-cost WAN links instead of the optimized middle-mile WAN or PAYG links in the core region.  </p> <ul> <li> <p>Let's verify this from SDWAN manager.  </p> </li> <li> <p>Go to Monitor &gt; Devices &gt; EDGE-BRANCH-5-01 </p> </li> </ul> <p> </p> <ul> <li>Select Troubleshooting from the navigation panel on the left and then select Simulate Flows </li> </ul> <p> </p> <ul> <li>In the Simulate Flows window, enter the following parameters for simulated flow.  <ul> <li>VPN : VPN- 10</li> <li>Source/Interface for VPN - 10: GigabitEthernet3 </li> <li>Source IP: 10.50.1.129 </li> <li>Destination IP: 10.60.1.101 </li> </ul> </li> <li>Click Simulate, and you should see output similar to the screenshot below. </li> </ul> <p> </p> <ul> <li> <p>As you can see the output from simulated flow, there are multiple paths available from site 5000 to site 6000. You can try different IPs in site 6000 and or site 7000 and see what is the output.  </p> </li> <li> <p>We can also confirm this from CLI.  </p> </li> <li>Go to the mRemoteNG client and SSH into the EDGE-BRANCH-5-01 and then issue the command show ip route vrf 10.</li> </ul> <p></p> <ul> <li>As we can see from the output, all prefixes from the East Region have 3 TLOCs IP pointing to, two being through the West Border routers, and one being the Originator TLOC IP for the direct path.  </li> </ul>"},{"location":"task8/","title":"Task 8 - MRF Central Policy","text":"<p>Another use case for secondary region is to set different preference for different VPNs. </p> <p>In this task you will create a Multi-Region Fabric (MRF) Control Policy that will steer VPN 11 traffic through the direct path over the Secondary Region while all other VPN 10 traffic will ECMP through all paths.</p>"},{"location":"task8/#step-1-create-a-new-control-policy","title":"Step 1: Create a New Control Policy","text":"<ul> <li>Go to Configuration &gt; Policies &gt; Add Policy</li> </ul> <ul> <li>On the left-side pane from the first section, select Region and then click \u2018New Region List\u2019</li> </ul> <ul> <li>Name this Region List as ACCESS with the regions 1,2.</li> </ul> <ul> <li> <p>Click \u2018Add\u2019.</p> </li> <li> <p>Also, let\u2019s create a Site List, so click on the left-side pane \u2018Site\u2019 and then \u2018+ New Site List\u2019.</p> </li> </ul> <p></p> <ul> <li>Name it as SECONDARY_REGION_SITES with the Sites 5000,6000,7000</li> </ul> <p></p> <ul> <li> <p>Click \u2018Add\u2019 and then \u2018Next\u2019. </p> </li> <li> <p>Now, click Add Topology and select Custom Control (Route &amp; Tloc)</p> </li> </ul> <p></p> <ul> <li>Name this Control Policy as MRF_CP.</li> </ul> <p></p> <ul> <li>Click \u2018+ Sequence Type\u2019 and then select \u2018TLOC\u2019</li> </ul> <p></p> <ul> <li>Next, click on \u2018+ Sequence Rule\u2019, and select \u2018Actions\u2019 and finally enable \u2018Accept\u2019</li> </ul> <p></p> <ul> <li> <p>Click \u2018Save Match and Actions\u2019.</p> </li> <li> <p>Now, again click \u2018+ Sequence Type\u2019, but this time select \u2018Route\u2019</p> </li> </ul> <p></p> <ul> <li>Click on \u2018+ Sequence Rule\u2019, and under the \u2018Match\u2019 section, select \u2018Region\u2019 with the Region List ACCESS</li> </ul> <p></p> <ul> <li>Also, add a match for \u2018VPN\u2019 for VPN ID 11</li> </ul> <p></p> <ul> <li>Next, add one more match for \u2018Path Type\u2019 and select HIERARCHICAL</li> </ul> <p></p> <ul> <li>Click \u2018Actions\u2019 and leave the \u2018Reject\u2019 option enabled.</li> </ul> <p></p> <ul> <li> <p>Click 'Save Match and Actions'</p> </li> <li> <p>Click \u2018+ Sequence Rule\u2019 to add another rule, and do not select any match.</p> </li> </ul> <p></p> <ul> <li>Next, click \u2018Actions, and enable \u2018Accept\u2019.</li> </ul> <p></p> <ul> <li> <p>Click \u2018Save Match and Actions\u2019.</p> </li> <li> <p>Finally, click \u2018Save Control Policy\u2019.</p> </li> <li> <p>You will be returned to the next \u2018Configure Topology and VPN Membership\u2019 where now we can see the Control Policy we just created.</p> </li> </ul> <p></p> <ul> <li> <p>Click \u2018Next\u2019, and \u2018Next\u2019 once again till you get to the \u2018Apply Policies to Sites and VPNs\u2019 section.</p> </li> <li> <p>Name this Centralized Policy as MRF_POLICY, then click \u2018+ New Site/Region List\u2019 and enable \u2018Region\u2019 with ACCESS as the Outbound Region List as follows.</p> </li> </ul> <p></p> <ul> <li>Click 'Add'.</li> </ul> <p></p> <ul> <li>Finally click \u2018Save Policy\u2019.</li> </ul>"},{"location":"task8/#step-2-understand-activate-and-confirm-mrf-policy","title":"Step 2: Understand, Activate and Confirm MRF Policy","text":"<ul> <li>Before we activate this new MRF Policy, go to Configuration &gt; Policies and click \u2018Preview\u2019 on the MRF_POLICY policy we just created</li> </ul> <ul> <li>The goal of the MRF Control Policy is to prevent the advertisement of prefixes from Access Regions 1 and 2 with a hierarchical path and to limit the prefixes from VPN 11 to Sites 5000, 6000, and 7000 only.Try to understand the policy from preview.  </li> </ul> <p>This is a good use-case example where we want VPN 10, which carries our critical corporate traffic, to use the Core or the direct path with ECMP. At the same time, we want to route our Guest Traffic in VPN 11 through the direct path only at these sites with Secondary Regions, without affecting the rest of the access sites. This approach aims to reduce costs and bandwidth usage at the Core.  </p> <ul> <li>Activate the Policy the MRF_POLICY we just created.</li> </ul> <p></p> <ul> <li> <p>Click \u2018Activate\u2019 and \u2018Activate\u2019 once again.</p> </li> <li> <p>Now, SSH into EDGE-BRANCH-5-01 and issue the show command show ip route vrf 10.</p> </li> </ul> <p></p> <ul> <li> <p>As we can see on the output above, we do have all prefixes from the East Region using all paths available for ECMP, being through the Core or through the Direct Path.</p> </li> <li> <p>Now, run the show command show ip route vrf 11</p> </li> </ul> <p></p> <ul> <li> <p>As shown above, for VPN 11,  communication to the East Region is now only possible using the direct path as defined in the MRF Policy.  </p> </li> <li> <p>You can verify by running a trace from the Site-5000-VPN-10-Ubun Ubuntu host to the 10.60.1.101 that's in service VPN 10 of Site 6000.  </p> </li> </ul> <p></p> <ul> <li> <p>Because the ECMP hash, the traffic is going through the Core but it may go through the Direct Path as well.</p> </li> <li> <p>Finally, let\u2019s verify by running a trace from the Site-5000-VPN-11-Ubun Ubuntu host to the 10.61.1.101 that lives in service VPN 11 of Site 6000.  </p> </li> </ul> <p></p> <p>Success</p>"},{"location":"task8/#congratulations-you-have-completed-the-whole-lab","title":"Congratulations, you have completed the whole lab!!","text":""},{"location":"topology/","title":"Lab Topology","text":"<p>Network topology used in this lab are shown in below picture:  </p> <ul> <li>Regional Hub &amp; Spoke with BGP core  </li> </ul> <p> </p> <ul> <li>Multi-Region (MRF) SD-WAN Fanric  </li> </ul> <p> </p>"}]}